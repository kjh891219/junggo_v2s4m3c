<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="music">
  <insert id="create" parameterType="MusicVO">
  INSERT INTO music (ctno, title, deal_code, product_code
        , category, region, deal_way, purc_date, quantity
        , hprice, content, cnt, nickname, userid
        , passwd, tel, email, wdate, deal_status, thumb, file1, size1, file2, size2, file3, size3, file4, size4, file5, size5))
 values((SELECT NVL(MAX(ctno), 0)+1 as ctno FROM music), #{title}, #{deal_code}, #{product_code}
        , #{category}, #{region}, #{deal_way}, #{purc_date}, #{quantity}
        , #{hprice}, #{content}, 0, #{nickname}, #{userid}
        , #{passwd}, #{tel}, #{email}, sysdate, #{deal_status}, #{thumb}, #{file1}, #{size1}, #{file2}, #{size2}, #{file3}, #{size3}, #{file4}, #{size4}, #{file5}, #{size5})
  </insert> 

 <!-- 정보수정 -->
  <update id="update" parameterType="MusicVO">
 UPDATE music 
        set title= #{title}, deal_code= #{deal_code}, product_code= #{product_code}
        , category= #{category}, region= #{region}, deal_way= #{deal_way}, purc_date= #{purc_date}, quantity= #{quantity}
        , hprice= #{hprice}, content= #{content}, nickname= #{nickname}, userid= #{userid}
        , passwd= #{passwd}, tel= #{tel}, email= #{email}, deal_status= #{deal_status}
        , thumb = #{thumb}, file1 = #{file1} , size1 = #{size1}, file2 = #{file2}, size2 = #{size2}, file3 = #{file3}, size3 = #{size3}, file4 = #{file4}, size4 = #{size4}, file5 = #{file5}, size5 = #{size5}
WHERE ctno = #{ctno} and passwd = #{passwd}
  </update>

  <!-- 상세 조회 -->
  <select id="read" resultType="MusicVO" parameterType="int">
    SELECT ctno, title, deal_code, product_code
        , category, region, deal_way, purc_date, quantity
        , hprice, content, cnt, nickname, userid
        , passwd, tel, email, wdate, deal_status, thumb, file1, size1, file2, size2, file3, size3, file4, size4, file5, size5
    FROM music
    WHERE CTNO = #{ctno}
  </select>

  <!-- 전체 레코드 수 검색 -->
  <select id="count" resultType="int" parameterType="Map">
    SELECT count(ctno) as cnt
    FROM music
    
    <choose>
      <when test="col == 'title'">
        WHERE  title LIKE '%' || #{word} || '%' 
      </when>
      <when test="col == 'content'">
        WHERE  content LIKE '%' || #{word} || '%' 
      </when>
      <when test="col == 'title_content'">
        WHERE  title LIKE '%' || #{word} || '%'  OR content LIKE '%' || #{word} || '%' 
      </when>      
    </choose>
   
  </select>
  
   <!-- 조건 검색 -->
  <select id="list" resultType="MusicVO" parameterType="Map">
  SELECT ctno, title, deal_code, product_code
        , category, region, deal_way, purc_date, quantity
        , hprice, content, cnt, nickname, userid
        , passwd, tel, email, wdate, deal_status, thumb, file1, size1, file2, size2, file3, size3, file4, size4, file5, size5, r
  FROM(
  SELECT ctno, title, deal_code, product_code
        , category, region, deal_way, purc_date, quantity
        , hprice, content, cnt, nickname, userid
        , passwd, tel, email, wdate, deal_status, thumb, file1, size1, file2, size2, file3, size3, file4, size4, file5, size5, rownum as r
  FROM(
  SELECT ctno, title, deal_code, product_code
        , category, region, deal_way, purc_date, quantity
        , hprice, content, cnt, nickname, userid
        , passwd, tel, email, wdate, deal_status, thumb, file1, size1, file2, size2, file3, size3, file4, size4, file5, size5
  FROM music

  <choose>
    <when test="col == 'title'">
      WHERE title LIKE '%' || #{word} || '%'
    </when>
    <when test="col == 'content'">
      WHERE content LIKE '%' || #{word} || '%'
    </when>
    <when test="col == 'title_content'">
      WHERE title LIKE '%' || #{word} || '%' OR content LIKE '%' || #{word} || '%'
    </when>
  </choose>
  ORDER BY ctno desc
  )
  )
  WHERE <![CDATA[r >=#{startNum} AND r <= #{endNum}]]>
  </select>
  
   <!-- 코드 삭제 -->
  <delete id="delete" parameterType="int">
    DELETE FROM music
    WHERE ctno
    = #{ctno}
  </delete>

  <!-- 비밀번호체크 -->
  <select id="passwordCheck" resultType="int" parameterType="Map">
      SELECT COUNT(*) as cnt
      FROM music
      WHERE ctno=#{ctno} AND passwd=#{passwd}
   </select>
   
   <update id="setCnt" parameterType="int">
      UPDATE music
      SET cnt = cnt + 1
      WHERE ctno = #{ctno}
   </update>
   
 
</mapper>
